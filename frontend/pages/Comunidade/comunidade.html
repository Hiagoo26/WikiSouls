<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../../assets/icons/fogueira.png" type="image/x-icon">
    <link rel="stylesheet" href="../../styles/user.css">
    <link rel="stylesheet" href="../../styles/comunidade.css">
    <title>Comunidade Wiki Souls</title>
</head>
<body>
    <!-- Header -->
    <header class="wiki-header">
        <h1>Dark Souls Wiki</h1>
        <div class="header-user">
            <h3>Nickname</h3>
            <i class="fa-solid fa-user"></i>
        </div>
    </header>

    <!-- Conte√∫do principal -->
    <main class="wiki-container">
        <!-- Sidebar -->
        <aside class="wiki-sidebar">
            <ul>
                <li><a href="../../index.html">P√°gina Inicial</a></li>
                <li><a href="../ds1.html">Dark Souls I</a></li>
                <li><a href="../ds2.html">Dark Souls II</a></li>
                <li><a href="../ds3.html">Dark Souls III</a></li>
                <li><a href="comunidade.html" class="active">Comunidade</a></li>
            </ul>
        </aside>

        <!-- POSTS -->
        <section class="wiki-posts">
            <!-- Post Exemplo -->
            <article class="post">
                <div class="post-header">
                    <img src="../../assets/users/artorias.jpg" alt="Artorias" class="avatar">
                    <div>
                        <h3 class="username">Artorias</h3>
                        <span class="date">17/10/2025</span>
                    </div>
                </div>
                <p class="content">
                    Essa build √© perfeita pra quem quer usar armas pesadas logo no come√ßo do jogo.
                    Comece com a classe Cavaleiro, foque em For√ßa e Vigor, e equipe o Espad√£o assim que puder!
                </p>
                <img src="../../assets/images/artorias2.jpg" alt="Build de For√ßa" class="post-image">
            </article>

            <article class="post">
                <div class="post-header">
                    <img src="../../assets/users/solaire.jpg" alt="Solaire" class="avatar">
                    <div>
                        <h3 class="username">Solaire</h3>
                        <span class="date">15/10/2025</span>
                    </div>
                </div>
                <p class="content">
                    Na √°rea das Muralhas de Lothric, antes do primeiro boss, tem um cavaleiro que dropa
                    cerca de 4000 almas por run ‚Äî √≥timo pra upar no early game. PRAISE THE SUN ‚òÄÔ∏è
                </p>
                <img src="../../assets/posts/farm.jpg" alt="Farm de Almas" class="post-image">
            </article>

            <article class="post">
                <div class="post-header">
                    <img src="../../assets/users/gwyn.jpg" alt="Gwyn" class="avatar">
                    <div>
                        <h3 class="username">Gwyn</h3>
                        <span class="date">14/10/2025</span>
                    </div>
                </div>
                <p class="content">
                    Qual foi o boss mais dif√≠cil pra voc√™s? Pra mim foi a Irm√£ Friede ‚Äî a terceira fase √© insana.
                </p>
                <img src="../../assets/posts/friede.jpg" alt="Boss Fight" class="post-image">
            </article>

            <!-- Bot√£o de Novo Post -->
            <button class="floating-btn" id="openModal">Ôºã</button>
        </section>

        <!-- Ranking -->
        <aside class="wiki-ranking">
            <h3>Ranking Populares</h3>
            <ol>
                <li>Imagem do Dark Souls Remastered</li>
                <li>Dica pro Dark Souls III</li>
                <li>Qual foi a primeira arma que voc√™s acharam?</li>
                <li>Onde encontrar a espada lend√°ria?</li>
            </ol>
        </aside>
    </main>

    <!-- Footer -->
    <footer class="wiki-footer">
        <p>Comunidade WikiSouls ¬© 2025</p>
    </footer>

    <!-- Modal Novo Post -->
    <div class="modal hidden" id="postModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Criar Novo Post</h2>
                <span class="close-modal" id="closeModal">&times;</span>
            </div>

            <form class="post-form">
                <textarea id="postText" placeholder="O que voc√™ quer compartilhar?" maxlength="500"></textarea>

                <div class="form-actions">
                    <label class="file-label" for="postImage">üì∑ Anexar Imagem</label>
                    <input type="file" id="postImage" accept="image/*">
                    <button type="button" id="publishPost" class="publish-btn">Publicar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Configura√ß√£o de Perfil -->
    <div class="modal" id="setupModal">
        <div class="modal-content setup">
            <h2>Personalize seu perfil</h2>
            <div class="avatar-upload">
            <label for="avatarInput">
                <img id="avatarPreview" src="../../assets/images/usuario.png" alt="Avatar" />
                <span>üì∑</span>
            </label>
            <input type="file" id="avatarInput" accept="image/*" hidden>
            </div>

            <input type="text" id="nickInput" placeholder="Escolha seu nickname">

            <div class="setup-actions">
            <button id="saveProfile">Salvar</button>
            </div>
        </div>
    </div>
    

    <script src="../../scripts/Modals/NewPostModal.js"></script>
    <script>
        console.log("Rodando!")
        document.addEventListener("DOMContentLoaded", async () => {
        const modal = document.getElementById("setupModal");
        const avatarInput = document.getElementById("avatarInput");
        const avatarPreview = document.getElementById("avatarPreview");
        const nickInput = document.getElementById("nickInput");
        const saveBtn = document.getElementById("saveProfile");
        const token = localStorage.getItem("token");

        // üîπ Se n√£o tiver token, n√£o mostra modal nem tenta carregar perfil
        if (!token) {
            modal.style.display = "none";
            return;
        }

        try {
            // üîπ Busca os dados do usu√°rio logado
            const res = await fetch("http://localhost:2611/api/auth/eu", {
            headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Falha ao verificar usu√°rio.");
            const user = await res.json();

            console.log("Usu√°rio logado:", user);

            // üîπ Mostra o modal s√≥ se nick for o padr√£o e avatar for o default
            if (
            user.nick === "Usu√°rio" ||
            user.nick.startsWith("Usu√°rio") ||
            !user.avatar ||
            user.avatar.includes("default.png")
            ) {
            modal.style.display = "flex";
            } else {
            modal.style.display = "none";
            localStorage.removeItem("needsSetup");
            }

            // Preview da imagem
            avatarInput.addEventListener("change", () => {
            const file = avatarInput.files[0];
            if (file) avatarPreview.src = URL.createObjectURL(file);
            });

            // Bot√£o salvar perfil
            saveBtn.addEventListener("click", async () => {
            const nick = nickInput.value.trim();
            if (!nick) return alert("Digite um nickname!");

            // Atualiza nick
            const resNick = await fetch("http://localhost:2611/api/user/nick", {
                method: "PATCH",
                headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ nick })
            });

            if (!resNick.ok) {
                const erro = await resNick.json();
                return alert(erro.erro || "Erro ao salvar nickname");
            }

            // Atualiza avatar se tiver imagem
            if (avatarInput.files.length > 0) {
                const formData = new FormData();
                formData.append("imagem", avatarInput.files[0]);
                await fetch("http://localhost:2611/api/user/avatar", {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
                });
            }

            // Feedback e fechamento suave
            alert("Perfil atualizado com sucesso!");
            modal.style.opacity = "0";
            setTimeout(() => {
                modal.style.display = "none";
                localStorage.removeItem("needsSetup");
                location.reload();
            }, 300);
            });
        } catch (err) {
            console.error("Erro ao carregar perfil:", err);
        }
        });
    </script>
</body>
</html>
