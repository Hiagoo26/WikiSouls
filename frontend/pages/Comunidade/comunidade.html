<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../../assets/icons/fogueira.png" type="image/x-icon">
    <link rel="stylesheet" href="../../styles/user.css">
    <link rel="stylesheet" href="../../styles/comunidade.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Comunidade Wiki Souls</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="wiki-header">
        <button class="menu-button" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 448">
                <path d="M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z"/>
            </svg>
        </button>
        <h1>Dark Souls Wiki</h1>
        <img src="../../assets/icons/fogueira.png" alt="bonfire" class="bonfire">
        <div class="header-user">
            <a href=""><img class="user-avatar" src="https://i.imgur.com/default.png" alt="Avatar"></a>
            <a href="" style="text-decoration: none;"><h3 class="user-nick">Nickname</h3></a>
        </div>
    </header>

    <!-- ConteÃºdo principal -->
    <main class="wiki-container">
        <!-- Sidebar -->
        <div id="overlay" class="overlay hidden">
            <aside id="sideBar" class="sideBar">
                <i class="fa-solid fa-xmark close" id="fecharSideBar"></i>
                <nav>
                    <h1>Dark Souls Wiki</h1>
                    <ul>
                        <li><a href="../../index.html">InÃ­cio</a></li>
                        <li><a href="../ds1.html">Dark Souls I</a></li>
                        <li><a href="../ds2.html">Dark Souls II</a></li>
                        <li><a href="../ds3.html">Dark Souls III</a></li>
                        <li><a href="comunidade.html">Comunidade</a></li>
                    </ul>
                    <div class="sideBar-btns">
                        <a href="../Login/login.html" class="btnheader1">Entrar</a>
                        <a href="../Login/login.html" class="btnheader1">Cadastre-se</a>
                    </div>
                    <a href="" style="text-decoration: none;"> <div class="sideBar-user">
                            <img class="side-avatar" src="https://i.imgur.com/default.png" alt="Avatar">
                            <h3 class="side-nick">UsuÃ¡rio</h3>
                        </div>
                    </a>
                </nav>
            </aside>
        </div>
        <aside class="wiki-sidebar">
            <ul>
                <li><a href="../../index.html">PÃ¡gina Inicial</a></li>
                <li><a href="../ds1.html">Dark Souls I</a></li>
                <li><a href="../ds2.html">Dark Souls II</a></li>
                <li><a href="../ds3.html">Dark Souls III</a></li>
                <li><a href="comunidade.html" class="active">Comunidade</a></li>
            </ul>
        </aside>
        <!-- POSTS -->
        <section class="wiki-posts" id="post-list">
        </section>
        <!-- BotÃ£o de Novo Post -->
        <button class="floating-btn" id="openModal">ï¼‹</button>

        <!-- Ranking -->
        <aside class="wiki-ranking">
            <h3>Ranking Populares</h3>
            <ol id="ranking-list" style="color: var(--firstcolor); text-decoration: none;">
            </ol>
        </aside>
    </main>

    <!-- Footer -->
    <footer class="wiki-footer">
        <p>Comunidade WikiSouls Â© 2025</p>
    </footer>

    <!-- Modal Novo Post -->
    <div class="modal hidden" id="postModal">
        <div class="modal-content">
            <div class="modal-header">
            <h2>Criar Novo Post</h2>
            <span class="close-modal" id="closeModal">&times;</span>
            </div>

            <form class="post-form">
            <!-- Campo de tÃ­tulo -->
            <input 
                type="text" 
                id="postTitle" 
                placeholder="Digite o tÃ­tulo do post" 
                maxlength="100" 
                class="post-title-input"
            >

            <!-- Campo de texto -->
            <textarea 
                id="postText" 
                placeholder="Escreva seu texto aqui..." 
                maxlength="500" 
                class="post-textarea"
            ></textarea>

            <!-- PrÃ©-visualizaÃ§Ã£o da imagem -->
            <div class="preview-container hidden" id="imagePreviewContainer">
                <img id="imagePreview" class="image-preview" alt="PrÃ©via da imagem">
            </div>

            <!-- Upload + BotÃ£o -->
            <div class="form-actions">
                <label class="file-label" for="postImage">ðŸ“· Anexar Imagem</label>
                <input type="file" id="postImage" accept="image/*">
                <button type="button" id="publishPost" class="publish-btn">Publicar</button>
            </div>
            </form>
        </div>
    </div>

    <!-- Modal de ConfiguraÃ§Ã£o de Perfil -->
    <div class="modal" id="setupModal">
        <div class="modal-content setup">
            <h2>Personalize seu perfil</h2>
            <div class="avatar-upload">
            <label for="avatarInput">
                <img id="avatarPreview" src="../../assets/images/usuario.png" alt="Avatar" />
                <span>ðŸ“·</span>
            </label>
            <input type="file" id="avatarInput" accept="image/*" hidden>
            </div>

            <input type="text" id="nickInput" placeholder="Escolha seu nickname">

            <div class="setup-actions">
            <button id="saveProfile">Salvar</button>
            </div>
        </div>
    </div>
    
    
    <script src="../../scripts/auth-check.js"></script>
    <script src="../../scripts/Modals/NewPostModal.js"></script>
    <script src="../../scripts/sideBar.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
        const modal = document.getElementById("setupModal");
        const avatarInput = document.getElementById("avatarInput");
        const avatarPreview = document.getElementById("avatarPreview");
        const nickInput = document.getElementById("nickInput");
        const saveBtn = document.getElementById("saveProfile");
        const token = localStorage.getItem("token");

        if (!token) {
            modal.style.display = "none";
            return;
        }

        try {
            // ðŸ”¹ Busca os dados do usuÃ¡rio logado
            const res = await fetch("https://wikisouls-production.up.railway.app/api/auth/eu", {
            headers: { "Authorization": `Bearer ${token}` },
            cache: "no-store"
            });

            if (!res.ok) throw new Error("Falha ao verificar usuÃ¡rio.");
            const user = await res.json();

            if (
            user.nick === "UsuÃ¡rio" ||
            user.nick.startsWith("UsuÃ¡rio") ||
            !user.avatar ||
            user.avatar.includes("default.png")
            ) {
            modal.style.display = "flex";
            } else {
            modal.style.display = "none";
            localStorage.removeItem("needsSetup");
            }

            // Preview da imagem
            avatarInput.addEventListener("change", () => {
            const file = avatarInput.files[0];
            if (file) avatarPreview.src = URL.createObjectURL(file);
            });

            // BotÃ£o salvar perfil
            saveBtn.addEventListener("click", async () => {
            const nick = nickInput.value.trim();
            if (!nick) return alert("Digite um nickname!");

            // Atualiza nick
            const resNick = await fetch("https://wikisouls-production.up.railway.app/api/user/nick", {
                method: "PATCH",
                headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ nick })
            });

            if (!resNick.ok) {
                const erro = await resNick.json();
                return alert(erro.erro || "Erro ao salvar nickname");
            }

            // Atualiza avatar se tiver imagem
            if (avatarInput.files.length > 0) {
                const formData = new FormData();
                formData.append("imagem", avatarInput.files[0]);
                await fetch("https://wikisouls-production.up.railway.app/api/user/avatar", {
                method: "POST",
                headers: { "Authorization": `Bearer ${token}` },
                body: formData
                });
            }

            // Feedback e fechamento suave
            alert("Perfil atualizado com sucesso!");
            modal.style.opacity = "0";
            setTimeout(() => {
                modal.style.display = "none";
                localStorage.removeItem("needsSetup");
                location.reload();
            }, 300);
            });
        } catch (err) {
            console.error("Erro ao carregar perfil:", err);
        }
        });
    </script>
    <script src="../../scripts/comunidade.js"></script>
</body>
</html>
